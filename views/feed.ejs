<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PicStudio - Feed</title>
  <link rel="stylesheet" href="/stylesheets/header.css">
  <link rel="stylesheet" href="/stylesheets/feed.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>

  <nav class="header">
    <div class="nav-left">
      <a href="/feed" class="logo">PicStudio</a>
    </div>
    <div class="nav-center">
      <form action="/feed" method="GET" class="search-bar">
        <i class="ri-search-line"></i>
        <input type="text" name="search" placeholder="Search">
      </form>
    </div>
    <div class="nav-right">
      <ul class="navigation">
        <li><a href="/feed" class="active" title="Home"><i class="ri-home-fill"></i></a></li>
        <li><a href="/profile" title="Profile"><i class="ri-user-3-line"></i></a></li>
        <li><a href="/logout" title="Logout"><i class="ri-logout-box-r-line"></i></a></li>
      </ul>
      <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
        <i class="ri-moon-line"></i>
      </button>
    </div>
  </nav>

  <main class="container">
    <% if (typeof noResults !=='undefined' && noResults) { %>
      <div class="no-results-banner">
        <i class="ri-error-warning-line"></i>
        <span>No results found for your search.</span>
      </div>
      <% } %>
        <div class="feed-grid">
          <% posts.slice().reverse().forEach(function(post){ %>
            <div class="feed-item">
              <div class="image-wrapper">
                <img src="./images/uploads/<%= post.image %>" alt="<%= post.imageText %>">
                <div class="overlay">
                  <div class="overlay-content">
                    <h3 class="post-caption">
                      <%= post.imageText %>
                    </h3>
                    <div class="post-meta">
                      <span class="post-author"><i class="ri-user-line"></i>
                        <%= post.user ? post.user.username : 'Unknown' %>
                      </span>
                      <button class="share-btn" data-post-id="<%= post._id %>" data-post-caption="<%= post.imageText %>"
                        data-post-image="<%= post.image %>" title="Share">
                        <i class="ri-share-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <% }) %>
        </div>
  </main>

  <div id="imageModal" class="image-modal">
    <span class="close-btn">&times;</span>
    <div class="modal-content">
      <img class="modal-image" id="modalImage">
      <div class="modal-caption" id="modalCaption"></div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <div class="share-modal-header">
        <h3>Share Post</h3>
        <button class="share-close-btn">&times;</button>
      </div>
      <div class="share-options">
        <button class="share-option copy-link" id="copyLinkBtn">
          <i class="ri-link"></i>
          <span>Copy Link</span>
        </button>
        <a class="share-option twitter" id="twitterShare" target="_blank" rel="noopener noreferrer">
          <i class="ri-twitter-x-fill"></i>
          <span>Twitter</span>
        </a>
        <a class="share-option facebook" id="facebookShare" target="_blank" rel="noopener noreferrer">
          <i class="ri-facebook-fill"></i>
          <span>Facebook</span>
        </a>
        <a class="share-option whatsapp" id="whatsappShare" target="_blank" rel="noopener noreferrer">
          <i class="ri-whatsapp-fill"></i>
          <span>WhatsApp</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="ri-check-line"></i>
    <span id="toastMessage">Link copied to clipboard!</span>
  </div>

  <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
  <script>
    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = themeToggle.querySelector('i');

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      themeIcon.classList.remove('ri-moon-line');
      themeIcon.classList.add('ri-sun-line');
    }

    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');

      if (document.body.classList.contains('dark-mode')) {
        themeIcon.classList.remove('ri-moon-line');
        themeIcon.classList.add('ri-sun-line');
        localStorage.setItem('theme', 'dark');
      } else {
        themeIcon.classList.remove('ri-sun-line');
        themeIcon.classList.add('ri-moon-line');
        localStorage.setItem('theme', 'light');
      }
    });

    // Initialize Masonry after images are loaded
    var grid = document.querySelector('.feed-grid');
    var msnry;

    imagesLoaded(grid, function () {
      msnry = new Masonry(grid, {
        itemSelector: '.feed-item',
        columnWidth: '.feed-item',
        percentPosition: true,
        gutter: 0
      });
      grid.classList.add('loaded');
    });

    // Modal Logic
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const modalCaption = document.getElementById('modalCaption');
    const closeBtn = document.querySelector('.close-btn');
    const images = document.querySelectorAll('.image-wrapper img');

    images.forEach(img => {
      img.parentElement.addEventListener('click', function () {
        modal.classList.add('show');
        modalImg.src = img.src;
        modalCaption.textContent = img.alt;
      });
    });

    closeBtn.onclick = function () {
      modal.classList.remove('show');
    }

    modal.onclick = function (e) {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    }

    // Close on Escape key
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.classList.contains('show')) {
        modal.classList.remove('show');
      }
      if (e.key === 'Escape' && shareModal.classList.contains('show')) {
        shareModal.classList.remove('show');
      }
    });

    // Share Modal Logic
    const shareModal = document.getElementById('shareModal');
    const shareCloseBtns = document.querySelectorAll('.share-close-btn');
    const shareButtons = document.querySelectorAll('.share-btn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const twitterShare = document.getElementById('twitterShare');
    const facebookShare = document.getElementById('facebookShare');
    const whatsappShare = document.getElementById('whatsappShare');
    const toast = document.getElementById('toast');

    let currentPostUrl = '';
    let currentPostCaption = '';

    // Open share modal
    shareButtons.forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        const postId = this.dataset.postId;
        const postCaption = this.dataset.postCaption;
        const postImage = this.dataset.postImage;

        // Generate post URL (you can customize this)
        currentPostUrl = `${window.location.origin}/post/${postId}`;
        currentPostCaption = postCaption;

        // Update social media share links
        const encodedUrl = encodeURIComponent(currentPostUrl);
        const encodedCaption = encodeURIComponent(postCaption);

        twitterShare.href = `https://twitter.com/intent/tweet?text=${encodedCaption}&url=${encodedUrl}`;
        facebookShare.href = `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`;
        whatsappShare.href = `https://wa.me/?text=${encodedCaption}%20${encodedUrl}`;

        shareModal.classList.add('show');
      });
    });

    // Close share modal
    shareCloseBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        shareModal.classList.remove('show');
      });
    });

    shareModal.addEventListener('click', function (e) {
      if (e.target === shareModal) {
        shareModal.classList.remove('show');
      }
    });

    // Copy link functionality
    copyLinkBtn.addEventListener('click', async function () {
      try {
        await navigator.clipboard.writeText(currentPostUrl);
        showToast('Link copied to clipboard!');
        shareModal.classList.remove('show');
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentPostUrl;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Link copied to clipboard!');
        shareModal.classList.remove('show');
      }
    });

    // Show toast notification
    function showToast(message) {
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>

</html>